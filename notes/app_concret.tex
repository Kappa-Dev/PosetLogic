\subsection{The concretisation function}
\label{sec:app_concret}

Let $s = (E,\seq,\prec,\dashv,\labl)$ be a linear extension of an augmented poset.
In the algorithm proposed on~\autoref{sec:concret} we change~\autoref{eq:refine} so that instead of computing a new decoration for each new poset $s_2$ (\autoref{eq:dec}), we use the existing decoration $(s_1)^{\star}$ of $s_1$ and only refine the trace w.r.t. to the decorations for the new event $e$ added to the trace.

Also we change the interpretation of the refinement function $\mathtt{Ref}$: instead of a bijection between events and transitions in $\theta$, we use a bijection between events and transitions positions in $\theta$ (\autoref{eq:ith_trans}). The update of $\mathtt{Ref}_1$ to $\mathtt{Ref}_2$ is then straightforward.

\begin{align}
  &\mathsf{concretise}(s,s_1,\mathit{concretisations}_1) = \\
  &\quad\text{if }(E_s\setminus E_{s_1} = \emptyset)\text{ then return }\mathit{concretisations}_1\\
  &\quad e = \text{min}_{\sqsubset}(E_s\setminus E_{s_1})\\
  &\quad\mathit{concretisations}_2 = \emptyset \\
  &\quad\text{for each }(s_1,\theta_1,\mathtt{Ref}_1)\text{ in }\mathit{concretisations}_1\\
  &\quad\qquad s_2 = s_{\{s_1\cup\{e\}\}}\\
  \label{eq:dec}
  &\quad\qquad\text{for each }(s_2)^{\star}\text{ in }\mathsf{decorate}(s_2)\\
  &\quad\qquad\qquad (s_1)^{\star} = \mathsf{decoration\_of\_trace}(\theta_1)\\
  &\quad\qquad\qquad \text{ if }s_2^{\star}\subseteq (s_1)^{\star}\text{ and }\mathsf{valid}(s_2^{\star})\text{ then }\\
  &\quad\qquad\qquad\qquad \mathit{spans} = \mathsf{decorations\_for\_last\_event}(s_2^{\star})\\
  \label{eq:refine}
  &\quad\qquad\qquad\qquad \mathit{\theta_2} = \mathsf{refine}(\theta_1,\mathtt{Ref}_1,\labl(e),\mathit{spans})\\
  &\quad\qquad\qquad\qquad \mathtt{Ref}_2 = \mathtt{Ref}_1\cup\{e\leftrightarrow\mathsf{length}(\theta_2)\}\\
  &\quad\qquad\qquad\qquad \mathit{concretisations}_2 = \mathit{concretisations}_2 \cup (s_2,\mathit{\theta_2},\mathtt{Ref}_2)\\
  &\quad\text{return }\mathit{concretisations}_2
\end{align}

%%%%%!!alternative : discover on the fly the decorations (let's call them discovered-deco) between the last transition in the trace $\theta$ and the new production $\labl(e)$. Then have to show that all decorations are preserved by the discovered-deco. A start is in the file \input{refine_rules}.

The spans are either positive or negative influences:
\begin{align*}
  \mathit{positive\_influences} = \{ \mathit{span}:R_i\remb O_i\lemb L \text{ where } e_i\redl{+}_{\mathit{span}} e, e_i\sqsubseteq e\} \\
  \mathit{negative\_influences} = \{ \mathit{span}:L_i\remb O_i\lemb L \text{ where } e\redl{-}_{\mathit{span}} e_i, e_i\sqsubseteq e\}
\end{align*}

Note that from~\autoref{def:linears}, for any events $e_i$,$e$ in an augmented poset, if $e_i\redl{+} e$ or $e\redl{-}e_i$ then $e_i\sqsubseteq e$.

\begin{definition}[Id graphs]
  We define an \emph{id graph} as a simple graph $G = (V,E)$ equipped with an identity function on nodes $\idf:V\to \nat$ such that $\forall n_1, n_2\in V$, if $\idf(n_1)=\idf(n_2)$ then $n_1 = n_2$.
%where each node has associated an id unique in the graph: $n=(i,v)$ , where $v\in V$ and $i\in\nat$.

  Morphisms on id graphs preserves the identity function on nodes.
\end{definition}

Id graphs will help us keep track of the decorations.

\begin{remark}
\label{rm:simply}
  We make two simplifying assumptions. First, if an event uses an already introduced node then it is accounted for in one of its decorations. All nodes that are no part of any decorations are \emph{new} nodes that have \emph{fresh identifiers}.

Secondly, we will assume that for any node there exists an event that introduces it. New nodes always appear in the lhs of rules.
This assumption allows us to reason by induction on the linearisation of a poset.
\end{remark}

The following example shows how much the simplfying assumptions help.
\begin{example}
 Let us consider the poset of events $e_1,e_2,e_3,e_4$ with $e_3\dashv e_1$, $e_3\dashv e_2$ and all events $e_1,e_2,e_3$ causing event $e_4$. The rules are the following
 \begin{align*}
   r_1:A \Rightarrow A,B\qquad r_2:A \Rightarrow A,C \qquad r_3:A\Rightarrow D\qquad r_4:B,C,D\Rightarrow \varepsilon
 \end{align*}
 We can see that for such a poset we cannot construct the trace by induction on any linearisation. The constraint of node $A$ being the same node in both $e_1$ and $e_2$ only shows when event $e_3$ is considered. The second sumplying assumption of~\autoref{rm:simply} requires an introductory event for $A$.
\end{example}

We give the algorithm for $\mathsf{refine}$ below. It consists of first updating the graph $L$ of a production $p$ to account for all decorations in $\mathit{spans}$ (\autoref{eq:idprod1} to~\autoref{eq:idprod2}). Then a new transition $t$ is obtained from $p$ (\autoref{eq:newt}).
%Then the graphs in the trace are updated to account for the new added transition (\autoref{eq:newtrace}).
\begin{align}
  &\mathsf{refine}(\theta:M_1\Rightarrow M_2\cdots M_n,\mathtt{Ref},p:L\remb D\lemb R,\mathit{spans}) = \\
  \label{eq:idprod1}
  &\quad\mathit{id\_nodes} = \emptyset\\
  &\quad\text{for each }v\in L\\
  &\quad\qquad\text{if there exists }s:G\overset{g}{\remb}O\overset{o}{\lemb}L\text{ in }\mathit{spans}\text{ such that }
  o^{-1}(v)=v_o\in O\\
  &\quad\qquad\text{then }\mathit{id\_nodes} =\mathit{id\_nodes} \cup\{(v,\mathsf{id}(g(v_o))\}\\
  &\quad\qquad\text{else }\mathit{id\_nodes} =\mathit{id\_nodes} \cup\{(v,\mathit{fresh\_id})\}\\
  &\quad L_I = \mathsf{transform\_in_\_idgraph}(L,\mathit{id\_nodes})\\
  \label{eq:idprod2}
  &\quad p_I:L_I\remb D_I\lemb R_I = \mathsf{transform\_in_\_idproduction}(p,L_I)\\
  %&\quad M_n' = M_n\cup L_I \\
  \label{eq:newt}
  &\quad t = M_n\overset{L_I\lemb M_n,p}{\Rightarrow} M_{n+1}\\
  %\label{eq:newtrace}
  %&\quad \theta_2 = \mathsf{update\_trace}(M_1\Rightarrow M_2\cdots M_n, M_n\lemb M_n')\\
  &\quad \text{return }\theta;t
\end{align}

The trace $\theta:M_1\Rightarrow M_2\cdots M_n$ is obtained by induction on $s_1$, therefore $M_1,\cdots M_n$ are id graphs.

Let us first show that producing an id graph from $L$ in \autoref{eq:idprod1} to \autoref{eq:idprod2} is correct: there are no two decorations that disagree on the identifier of a node. The second part of the following lemma says that adding a new transition to the trace does not reintroduce node identifiers.

\begin{lemma}
  \label{lem:correction}
  Let us suppose we have the following:
  \begin{itemize}
  \item two linear augmented posets $s_1$, $s_2$ such that $s_2=s_1\cup\{e\}$ and $e$ is maximal in $s_2$;
  \item two valid decorations for the two posets $s_1^{\star}$ and $s_2^{\star}$ with $s_2^{\star}\subseteq s_1^{\star}$;
  \item a trace $\theta:M_1\Rightarrow M_2\cdots M_n$ such that $\mathsf{decoration\_of\_trace}(\theta)=(s_1)^{\star}$ and such that $M_1,\cdots M_n$ are id graphs;
  \end{itemize}
  \begin{enumerate}
  \item For two decorations of $e$ in $s_2^{\star}$, $\mathit{span}_1$ and $\mathit{span}_2$ such that either
    \begin{enumerate}
    \item
      $R_1 \overset{g_1}{\remb} O_1 \overset{o_1}{\lemb} L \overset{o_2}{\remb} O_2\overset{g_2}{\lemb} R_2$ or
    \item $L_1 \overset{g_1}{\remb} O_1 \overset{o_1}{\lemb} L \overset{o_2}{\remb} O_2\overset{g_2}{\lemb} L_2$ or
    \item $L_1 \overset{g_1}{\remb} O_1 \overset{o_1}{\lemb} L \overset{o_2}{\remb} O_2\overset{g_2}{\lemb} R_2$.
    \end{enumerate}
    we have that for all $n\in L$ such that $o_1^{-1}(n) = n_1\in O_1$ and $o_2^{-1}(n) = n_2\in O_2$, $\text{id}(g_1(n_1)) = \text{id}(g_2(n_2))$.
  \item
  \label{lem:correction_2}
  Let $L_I$ be the id graph constructed as in \autoref{eq:idprod1} to~\autoref{eq:idprod2}. Then $L_I\subseteq M_n$.
\end{enumerate}
\end{lemma}
\begin{proof}
  \begin{enumerate}
  \item
    \begin{enumerate}
    \item It follows that there exists $e_1,e_2\in s_2^{\star}$ such that $e_1\redl{+}_{\mathit{span}_1} e$ and $e_2\redl{+}_{\mathit{span}_2} e$, with $\labl(e_i) = L_i\remb K_i\remb R_i$. We reason on the subscases of the constraint on decorating positive meets in~\autoref{def:constraints_poset} to deduce a contradiction:
      \begin{itemize}
      \item if $g(n_1)$ is in $K_1$ and $g(n_2)$ is in $K_2$ then we have that any event that has a positive influence on $e_1$ w.r.t. $n_1$ has a positive influence on $e_2$ w.r.t. $n_2$. Our simplyifing assumption~\autoref{rm:simply} ensures that there exists an event $e_n$ which introduces node $n_1$ and $n_2$ as a single node, hence the two nodes have the same id.
      \item otherwise, the only cases possible are either $e_1$ introduces node $n_1$ and $e_1\redl{+} e_2$ or the other way around. In both cases the two nodes are identified as the same node.
      \end{itemize}
    \item Similar to the case above, we use the constraint on decorating negative forks in~\autoref{def:constraints_poset} and the symplifying assumption~\autoref{rm:simply}.
    \item It follows that there exists $e_1,e_2\in s_2^{\star}$ such that $e_2\redl{+}_{\mathit{span}_2} e$ and $e\redl{-}_{\mathit{span}_2} e_1$. But then there exists a span ${\mathit{span}_3}$ such that $e_2\redl{+}_{\mathit{span}_3} e_1$ and from the constraint on decorating positive forks in~\autoref{def:constraints_poset} the common nodes in $O_1$ and $O_2$ have the same id.
    \end{enumerate}
  \item Suppose that there exists $n\in L_I$ and $n\notin M_n$. From the symplifying assumption~\autoref{rm:simply} there exists an event $e_1$ which introduces node $n$. But $n\notin M_n$, implies that there exists an event $e_2$ which "consumes" $n$, i.e. $e_1\redl{+} e_2$ and $e_2\redl{-} e$. %we cannot use this last part $e_2\redl{-}_n e$ because we haven't yet proved that the concretisation of s2 doesn't introduce extra decorations.
From $e_1\redl{+} e_2$ and $e_1\redl{+} e$ with node $n$ common to the two decorations, we have that the constraint on decorating positive forks in~\autoref{def:constraints_poset} is not satisfied.
  \end{enumerate}
\end{proof}

\begin{theorem}
  Let $s_1$ be a linear augmented poset, let $\theta_1$ be a trace and $\mathtt{Ref}_1$ a refinement function on $\theta_1$ such that the precedence and inhibition relations on transitions are preserved, i.e. for any events $e_1,e_2\in s_1$
  \begin{align*}
    e_1\prec e_2 \iff& \mathtt{Ref}(e_1) \prec_{\theta}\mathtt{Ref}(e_2)\\
    e_1\dashv e_2 \iff& \mathtt{Ref}(e_1) \dashv_{\theta}\mathtt{Ref}(e_2).
  \end{align*}
  Let $s_2$ be a linear augmented poset such that $s_2=s_1\cup\{e\}$ and $e$ is maximal in $s_2$ w.r.t. the total order in $s_2$.
  For any $\theta_2$ and $\mathtt{Ref}_2$ obtained by $\mathsf{concretise}(s_2,s_1,\{(\theta_1,\mathtt{Ref}_1)\})$ the precedence and inhibition relations on transitions are preserved.
\end{theorem}
\begin{proof}
  Let $s_1^{\star}$ be a decoration of $s_1$ such that $\mathsf{decoration\_of\_trace}(\theta_1)=(s_1)^{\star}$.
  First we note that we can translate the conditions above on decorations:
  \begin{align*}
    e_1\prec e_2 \iff&e_1\redl{+}_s e_2 \iff \mathtt{Ref}(e_1) \prec_{\theta}^{s}\mathtt{Ref}(e_2)\\
    e_1\dashv e_2 \iff&e_1\redl{-}_s e_2 \iff \mathtt{Ref}(e_1) \dashv_{\theta}^{s}\mathtt{Ref}(e_2)
  \end{align*}
  Moreover we only need to show that the constraints hold for the last event added to $s_2$.
  The first implication follows from the definition of low res precedence and inhibition (\autoref{def:dep}). In the diagram below
  \[
  \begin{tikzpicture} %[scale=0.8]
    \node (o) at (1,0) {\(O\)};
    \node (m1) at (-2,3) {\(M_1\)};
    \node (n1) at (0,3) {\(N_1\)};
    \node (n2) at (4,3) {\(N_2\)};
    \node (m2) at (2,3) {\(M_2\)};
    \node (r1) at (0,1) {\(R_1\)};
    \node (l1) at (-2,1) {\(L_1\)};
    \node (l2) at (2,1) {\(L_2\)};
    \node (r2) at (4,1) {\(R_2\)};
    \draw [->] (o) -- (r1);
    \draw [->] (o) -- (l2);
    \draw [->] (r1) --  (n1);
    \draw [->] (l2) --  (m2);
    \draw [dotted, ->] (n1) --  (m2);
    \draw [->] (l1) --  (m1);
    \draw [->] (r2) --  (n2);
    \draw [vecArrow] (m1) -- node [above,midway] {$m_1,p_1$} (n1);
    \draw [vecArrow] (m2) -- node [above,midway] {$m_2,p_2$} (n2);
    \draw [vecArrow] (l2) -- (r2);
    \draw [vecArrow] (l1) -- (r1);
  \end{tikzpicture}
  \]
  the partial morphism $N_1\pmorph M_2$ is defined using the identifiers on nodes. Because identifiers do not repeat (from~\autoref{lem:correction_2}), the morphism is well defined.

  For the reverse implication we have to show that the concretisation does not add additional decorations. It follows from~\autoref{def:constraints_poset}. Whenever two decorations identify a node in the left hand side of $e_1$ with a node in the left hand side of $e_2$ then the two events $e_1$ and $e_2$ are pairs for positive and negative influence.
\end{proof}
