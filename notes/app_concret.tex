\subsection{The concretisation function}
\label{sec:app_concret}

Let $s = (E,\seq,\cover,\prec,\dashv,\labl)$ be a linear extension of an augmented poset.
In the algorithm proposed on~\autoref{sec:concret} we change~\autoref{eq:refine} so that instead of computing a new decoration for each new poset $s_2$ (line~\autoref{eq:dec}), we use the existing decoration $(s_1)^{\star}$ of $s_1$ and only refine the trace w.r.t. to the decorations for the new event $e$ added to the trace.

\begin{align}
  &\mathsf{concretise}(s,s_1,\mathit{concretisations}_1) = \\
  &\quad\text{if }(E_s\setminus E_{s_1} = \emptyset)\text{ then return }\mathit{concretisations}_1\\
  &\quad e = \text{min}_{\sqsubset}(E_s\setminus E_{s_1})\\
  &\quad\mathit{concretisations}_2 = \emptyset \\
  &\quad\text{for each }(\theta_1,\mathtt{Ref}_1)\text{ in }\mathit{concretisations}_1\\
  &\quad\qquad s_2 = s\setminus\{s_1\cup\{e\}\}\\
  \label{eq:dec}
  &\quad\qquad\text{for each }(s_2)^{\star}\text{ in }\mathsf{decorate}(s_2)\\
  &\quad\qquad\qquad (s_1)^{\star} = \mathsf{decoration\_of\_trace}(\theta_1)\\
  &\quad\qquad\qquad \text{ if }s_2^{\star}\subseteq (s_1)^{\star}\text{ and }\mathsf{valid}(s_2^{\star})\text{ then }\\
  &\quad\qquad\qquad\qquad \mathit{spans} = \mathsf{decorations\_for\_last\_event}(s_2^{\star})\\
  \label{eq:refine}
  &\quad\qquad\qquad\qquad (\mathit{\theta_2},\mathtt{Ref}_2) = \mathsf{refine}(\theta_1,\mathtt{Ref}_1,\labl(e),\mathit{spans})\\
  &\quad\qquad\qquad\qquad \mathit{concretisations}_2 = \mathit{concretisations}_2 \cup (\mathit{\theta_2},\mathtt{Ref}_2)\\
  &\quad\text{return }\mathit{concretisations}_2
\end{align}

%%%%%!!alternative : discover on the fly the decorations (let's call them discovered-deco) between the last transition in the trace $\theta$ and the new production $\labl(e)$. Then have to show that all decorations are preserved by the discovered-deco. A start is in the file \input{refine_rules}.

The spans are either positive or negative influences:
\begin{align*}
  \mathit{positive\_influences} = \{ \mathit{span}:R_i\remb O_i\lemb L \text{ where } e_i\redl{+}_{\mathit{span}} e, e_i\sqsubseteq e\} \\
  \mathit{negative\_influences} = \{ \mathit{span}:L_i\remb O_i\lemb L \text{ where } e\redl{-}_{\mathit{span}} e_i, e_i\sqsubseteq e\}
\end{align*}

Note that from~\autoref{def:linears}, for any events $e_i$,$e$ in an augmented poset, if $e_i\redl{+} e$ or $e\redl{-}e_i$ then $e_i\sqsubseteq e$.

\begin{definition}[Id graphs]
  We define an \emph{id graph} $G_I = (N,E)$ as a simple graphs $G = (V,E)$ where each node has associated an id unique in the graph: $n=(i,v)$ , where $v\in V$ and $i\in\nat$.
\end{definition}

Id graphs will help us keep track of the decorations.

\begin{remark}
  We make the following simplifying assumption on events: if an event uses an already introduced node than it appears in one of its decorations. All nodes in an event that are no part of any decorations are \emph{new} nodes that have \emph{fresh identifiers}, not used by any other node in the trace.
\end{remark}

We give the algorithm for $\mathsf{refine}$ below. It consists of first updating the graph $L$ of a production $p$ to account for all decorations in $\mathit{spans}$ (\autoref{eq:idprod1} to~\autoref{eq:idprod2}).
\begin{align}
  &\mathsf{refine}(\theta:M_1\Rightarrow M_2\cdots M_n,\mathtt{Ref},p:L\remb D\lemb R,\mathit{spans}) = \\
  \label{eq:idprod1}
  &\quad\mathit{id\_nodes} = \emptyset\\
  &\quad\text{for each }v\in L\\
  &\quad\qquad\text{if there exists }s:G\overset{g}{\remb}O\overset{o}{\lemb}L\text{ in }\mathit{spans}\text{ such that }
  o^{-1}(v)=v_o\in O\\
  &\quad\qquad\text{then }\mathit{id\_nodes} =\mathit{id\_nodes} \cup\{(v,\mathsf{id}(g(v_o))\}\\
  &\quad\qquad\text{else }\mathit{id\_nodes} =\mathit{id\_nodes} \cup\{(v,\mathit{fresh\_id})\}\\
  &\quad L_I = \mathsf{transform\_in_\_idgraph}(L,\mathit{id\_nodes})\\
  \label{eq:idprod2}
  &\quad p_I:L_I\remb D_I\lemb R_I = \mathsf{transform\_in_\_idproduction}(p,L_I)\\
\end{align}

The trace $\theta:M_1\Rightarrow M_2\cdots M_n$ is obtained by induction on $s_1$, therefore $M_1,\cdots M_n$ are id graphs.

Let us first show that producing an id graph from $L$ in \autoref{eq:idprod1} to \autoref{eq:idprod2} is correct: there are no two decorations that disagree on the identifier of a node.

\begin{lemma}
  Let us suppose we have the following:
  \begin{itemize}
  \item two linear augmented posets $s_1$, $s_2$ such that $s_2=s_1\cup\{e\}$ and $e$ is maximal in $s_2$;
  \item two valid decorations for the two posets $s_1^{\star}$ and $s_2^{\star}$ with $s_2^{\star}\subseteq s_1^{\star}$;
  \item a trace $\theta:M_1\Rightarrow M_2\cdots M_n$ such that $\mathsf{decoration\_of\_trace}(\theta)=(s_1)^{\star}$ and such that $M_1,\cdots M_n$ are id graphs;
  \item two decorations of $e$ in $s_2^{\star}$, $\mathit{span}_1$ and $\mathit{span}_2$ such that either
    \begin{enumerate}
    \item $L_1 \overset{g_1}{\remb} O_1 \overset{o_1}{\lemb} L \overset{o_2}{\remb} O_2\overset{g_2}{\lemb} L_2$ or
    \item $R_1 \overset{g_1}{\remb} O_1 \overset{o_1}{\lemb} L \overset{o_2}{\remb} O_2\overset{g_2}{\lemb} R_2$ or
    \item $L_1 \overset{g_1}{\remb} O_1 \overset{o_1}{\lemb} L \overset{o_2}{\remb} O_2\overset{g_2}{\lemb} R_2$.
    \end{enumerate}
  \end{itemize}
  Then for all $n\in L$ such that $o_1^{-1}(n) = n_1\in O$ and $o_2^{-1}(n) = n_2\in O$, $\text{id}(g_1(n_1)) = \text{id}(g_2(n_2))$.
\end{lemma}
\begin{proof}
  \begin{enumerate}
  \item
  \item It follows that there exists $e_1,e_2\in s_2^{\star}$ such that $e\redl{+}_{\mathit{span}_1} e_1$ and $e\redl{+}_{\mathit{span}_2} e_2$ and that the constraint on decorating forks in~\autoref{def:constraints_poset} is not satisfied. Contradiction with the hypothesis that $s_2^{\star}$ is a valid decoration.
  \end{enumerate}
\end{proof}
