\subsection{From posets to traces}
%\input{old_concret}

%\input{old_ref}

%\subsection{Refinement of decorated posets}

\begin{lemma}[Update of a decoration after a refinement]
  \label{lem:update_dec}
  Let $(E,\redl{+},\redl{-},\labl)$ be a valid decorated poset and let $e_1$ and $e_2$ be two events such that $e_1\redl{+}_{s_1} e_2$ and $e_2\redl{-}_{s_2} e_1$, for two cospans $s_1$ and $s_2$ possibly empty.
  \begin{enumerate}
  \item If there exists $e_3$ and $s:R_i\remb O \lemb L_3$ such that $e_i\redl{+}_s e_3$ with $i\in\{1,2\}$ then there exists $s':M_2\lemb O'\remb L_3$ such that $\big( M_1\remb K\lemb M_2\big)\redl{+}_{s'} r_3$ and such that the diagram commutes:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (ri) at (-1,1) {\(R_i\)};
      \node (m2) at (3,1) {\(M_2\)};
      \node (l3) at (2,1) {\(L_3\)};
      \node (o) at (0,0) {\(O\)};
      \node (o1) at (2,0) {\(O'\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (l3);
      \draw [->] (o1) -- (l3);
      \draw [->] (o) -- (ri);
      \draw [->] (o1) -- (m2);
    \end{tikzpicture}
    \]
    where $\big(\labl(e_1)\otimes_{(s_1\times s_2)} \labl(e_2)\big) = M_1\remb K\lemb M_2$.
  %% \item If there exists $e_3$ and $s:L_i\remb O \lemb L_3$ such that $e_i\redl{-}_s e_3$ with $i\in\{1,2\}$ then there exists $s':M_1\lemb O'\remb L_3$ such that $\big( M_1\remb K\lemb M_2\big)\redl{-}_{s'} r_3$ and such that the diagram commutes:
  %%   \[
  %%   \begin{tikzpicture} %[scale=0.8]
  %%     \node (ri) at (-1,1) {\(L_i\)};
  %%     \node (m2) at (3,1) {\(M_1\)};
  %%     \node (l3) at (2,1) {\(L_3\)};
  %%     \node (o) at (0,0) {\(O\)};
  %%     \node (o1) at (2,0) {\(O'\)};
  %%     \draw [->] (o) -- (o1);
  %%     \draw [->] (o) -- (l3);
  %%     \draw [->] (o1) -- (l3);
  %%     \draw [->] (o) -- (ri);
  %%     \draw [->] (o1) -- (m2);
  %%   \end{tikzpicture}
  %%   \]
  %%   where $\big(\labl(e_1)\otimes_{(s_1\times s_2)} \labl(e_2)\big) = M_1\remb K\lemb M_2$.
  \item If there exists $e_3$ and $s:R_i\remb O \lemb L_3$ such that $e_3\redl{+}_s e_i$ with $i\in\{1,2\}$ then there exists $s':M_2\lemb O'\remb L_3$ such that $r_3\redl{+}_{s'}\big( M_1\remb K\lemb M_2\big)$ and such that the diagram commutes:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (ri) at (-1,1) {\(R_3\)};
      \node (m2) at (3,1) {\(M_1\)};
      \node (l3) at (2,1) {\(L_i\)};
      \node (o) at (0,0) {\(O\)};
      \node (o1) at (2,0) {\(O'\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (l3);
      \draw [->] (o1) -- (l3);
      \draw [->] (o) -- (ri);
      \draw [->] (o1) -- (m2);
    \end{tikzpicture}
    \]
    where $\big(\labl(e_1)\otimes_{(s_1\times s_2)} \labl(e_2)\big) = M_1\remb K\lemb M_2$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  \begin{enumerate}
  \item Let us first show the property above for $r_1$.
    We have the following diagram from~\autoref{def:ref_pos_neg_infl}, where $O_3$ is a graph such that $O_1\emb O_3$ and $O_2\emb O_3$.
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(O_3\)};
      \node (m) at (0,1) {\(M\)};
      \node (d2) at (1,1) {\(\circ\)};
      \node (m2) at (3,1) {\(M_2\)};
      \node (d1) at (-1,1) {\(D_1\)};
      \node (m1) at (-3,1) {\(\circ\)};
      \node (r1) at (-1,0) {\(R_1\)};
      \node (k1) at (-2,0) {\(K_1\)};
      \node (l1) at (-3,0) {\(\circ\)};
      \node (l2) at (1,0) {\(L_2\)};
      \node (k2) at (2,0) {\(\circ\)};
      \node (r2) at (3,0) {\(\circ\)};
      \node (k) at (0,2) {\(K\)};
      \node (l3) at (4,0.5) {\(L_3\)};
      \node (o2) at (2,-1) {\(O\)};
      \node (o1) at (4,-1) {\(O'\)};
      \draw [->] (o) -- (r1);
      \draw [->] (o) -- (l2);
      \draw [->] (r1) -- (m);
      \draw [->] (k1) -- (r1);
      \draw [->] (k1) -- (l1);
      \draw [->] (k1) -- (d1);
      \draw [->] (l1) -- (m1);
      \draw [->] (l2) -- (m);
      \draw [->] (k2) -- (r2);
      \draw [->] (k2) -- (l2);
      \draw [->] (k2) -- (d2);
      \draw [->] (r2) -- (m2);
      \draw [->] (d1) -- (m);
      \draw [->] (d1) -- (m1);
      \draw [->] (d2) -- (m);
      \draw [->] (d2) -- (m2);
      \draw [->] (k) -- (d1);
      \draw [->] (k) -- (d2);
      \draw [->] (o2) -- (o1);
      \draw [->] (o2) -- (l3);
      \draw [->] (o1) -- (l3);
      \draw [->] (o2) -- (r1);
      \draw [->] (o1) -- (m2);
    \end{tikzpicture}
    \]
    We have that $n_1(o(O))\subseteq M$. We distinguish two cases:
    \begin{itemize}
    \item if $n_1(o(O)) \cap m_2(L_2)=\emptyset$ then $f_2^{-1}$ is defined on $n_1(o(O))$. Hence there exists a morphism $o_2:O\emb M_2$ such that $o_2 = g_2 \circ (f_2^{-1}) \circ n_1 \circ o$. Moreover, as $O$ does not embed into $K_1$ (from $e_1\redl{+}_O e_3$), then we can show by contradiction that there is no morphism $O\emb D_1$ nor $O\emb K$ such that the diagram commutes. Therefore we have that there exists $O'$ such that $\labl(e_1)\otimes_{O_1,O_2} \labl(e_2)\redl{+}_{O'} e_3$ and $O\subseteq O'$.
    \item if $n_1(o(O)) \cap m_2(L_2)\neq\emptyset$, then again we distinguish two subcases. A first one is that $f_2^{-1}$ is defined on $n_1(o(O)) \cap m_2(L_2)$, in which case the proof follows as above. Otherwise, we have that there exists $O''\subseteq O$ such that $e_1\redl{+}_{O''} e_2$ and $e_1\redl{+}_{O''} e_3$ which contradicts the contraints on decoration of meets from~\autoref{prop:constraints_poset}.
    \end{itemize}

    The property holds for $r_2$ in a similar manner, except that we use the contraints on decoration of joins from~\autoref{prop:constraints_poset} for the last case.

  \item
    \begin{mdframed}[backgroundcolor=blue!20]
      to do
    \end{mdframed}
  \end{enumerate}
\end{proof}

  Let $e_1$ and $e_2$ be two events of a decorated poset and $s_1,s_2$ be two cospans such that $(\labl(e_1)\otimes_{s_1\otimes s_2} \labl(e_2)) = r_{12}$ is well defined. Moreover, let $e_3$ be an event and $s$ a cospan such that $e_1\redl{+}_s e_3$. We use the notation $\big(e_1\redl{+}_O e_3\big)_{e_1\otimes e_2}$ denotes the set of all decorations $r_{12}\redl{+}_{s'} \labl(e_3)$, where $s'$ is obtained as in~\autoref{lem:update_dec}. We use similar notations for the negative influence and the influences of $e_2$ on $e_3$.

\begin{lemma}[The update is associative]
  \label{lem:assoc}
   Let $e_1,e_2,e_3$ be three events in a decorated poset and $s_1,s_2$ be two cospans such that $e_1\redl{+}_{s_1} e_2\redl{+}_{s_2} e_3$.
   Moreover, let $e_1\oplus_{s_1} e_2 = r_{12}$ and $e_2\oplus_{s_2} e_3 = r_{23}$ be the two refinements.
   Then, for any cospan $s$ such that
   $r_{12}\redl{+}_{s} \labl(e_3)\in\big(e_2\redl{+}_{s_2} e_3\big)_{e_1\otimes e_2}$ there exists a graph $s'$ such that
   $\labl(e_{1})\redl{+}_{s'} r_{23}\in\big(e_1\redl{+}_{s_1} e_2\big)_{e_2\otimes e_3}$ and such that
   \begin{align*}
     (r_1\oplus_{s_1} r_2)\oplus_{s} r_3 \iso r_1\oplus_{s'} (r_2\oplus_{s_3} r_3).
   \end{align*}
\end{lemma}
\begin{mdframed}[backgroundcolor=blue!20]
  \begin{proof}
    to do
  \end{proof}
\end{mdframed}

\begin{mdframed}[backgroundcolor=blue!20]
Adapt \autoref{lem:update_dec} and \autoref{lem:assoc} to inhibition.
\end{mdframed}

\begin{definition}
  Let $e_1,e_2\in E$ be two events of a decorate poset $s$ such that $e_1\redl{+}_{s_1}e_2$, $e_2\redl{-}_{s_2}e_2$ for some $s_1$, $s_2$ possibly empty. Then $\labl(e_1)\otimes_{(s_1\otimes s_2)} r_2=r_{12}$ is well defined.

  Define $s_{(e_1\otimes e_2)} = (E\setminus\{e_1,e_2\}\uplus\{e_{12}\},\overset{+}{\leadsto},\overset{-}{\leadsto},\labl')$ such that
    \begin{align*}
    &\labl'(e)=\labl(e), \forall e,e'\in E\setminus\{e_1,e_2\}\\
    &e\overset{+}{\leadsto}_s e' \iff e\redl{+}_s e', \forall e,e'\in E\setminus\{e_1,e_2\}\\
    &e\overset{-}{\leadsto}_s e' \iff e\redl{-}_s e', \forall e,e'\in E\setminus\{e_1,e_2\}\\
    &\labl'(e_{12}) = r_{12}\\
    &e_{12}\overset{+}{\leadsto}_s e \iff r_{12}\redl{+}_s \labl(e)\in \big(e_i \redl{+}_{s'} e\big)_{e_1\otimes e_2}\\
   % \text{ and }e_i\redl{+}_{O'} e\\
    &e_{12}\overset{-}{\leadsto}_s e \iff r_{12}\redl{-}_s \labl(e)\in \big(e_i \redl{-}_{s'} e\big)_{e_1\otimes e_2}\\
    %\text{ and }e_i\redl{-}_{O'} e\\
  \end{align*}
\end{definition}
%% \begin{lemma}
%%   Let $\underline s = (E,\seq,\redl{+},\redl{-},\labl)$ be a linear extension of a decorated poset $s$. For any two events $e_1,e_2$ such that $\big(s \big)_{e_1\otimes e_2}$ is well defined, $\big(\underline s \big)_{e_1\otimes e_2}$ is a linear extension of $\big(s \big)_{e_1\otimes e_2}$.
%% \end{lemma}

\begin{lemma}
  If $s$ is a valid decorated poset then for any two events $e_1,e_2$ in $s$, $s_{(e_1\otimes e_2)}$ is also a valid decorate poset.
\end{lemma}


\begin{definition}[Refinement of a poset]
  \label{def:ref_poset}
  Let $\underline s=(E,\seq\redl{+},\redl{-},\labl)$ be a linear extension of a decorated poset $s$.
  Define $\mathtt{Ref}(\underline s)$ as follows
  \begin{align*}
    \mathtt{Ref}(\underline s) =&
    \mathtt{Ref}(\underline s')\text{ if }\exists e_1,e_2\in E, e_1\neq e_2, e_1\prec e_2, e_1\redl{+}e_2
    \text{ and }\underline s'=\big(\underline s\big)_{e_1\otimes e_2}
    \\
    &\underline s\text{ otherwise.}\\
  \end{align*}
\end{definition}
