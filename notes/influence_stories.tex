\section{Posets of graph rewriting events}

\subsection{From transition systems to posets}

\begin{definition}[Causal trace]
  \label{def:causal_trace}
  Let $\theta:M_0\overset{m_1,p_1}{\Rightarrow} M_1\overset{m_2,p_2}{\Rightarrow} M_2 \cdots \overset{m_n,p_n}{\Rightarrow} M_n$ be a trace.
  Two transitions $t_1$ and $t_2$ of $\theta$ are sequential dependent in $\theta$, if $t_1<_{\theta} t_2$ can be derived by the following rules:
  \begin{align*}
    \frac{t_1 < t_2}{t_1 <_{\theta} t_2}\quad
    \frac{t_1\simeq t_1'<t_2'\simeq t_2}{t_1 <_{\theta} t_2}
  \end{align*}
  A transition $t_1$ inhibits a transition $t_2$ of $\theta$, if $t_1\dashv_{\theta} t_2$ can be derived by the following rules:
  \begin{align*}
    \frac{t_1 \dashv t_2}{t_1 \dashv_{\theta} t_2}\quad
    \frac{t_1\simeq t_1'\dashv t_2'\simeq t_2}{t_1 \dashv_{\theta} t_2}
  \end{align*}

  Define $\leq$ the transitive and reflexive closure of sequential dependence. We say that $\theta$ is a \emph{causal trace} if it is directed w.r.t. $\leq$.
\end{definition}

\begin{lemma}
  \label{lem:inhibiting_pair}
  Let $t_1$ and $t_2$ be two transitions in a trace $\theta$ such that $t_1\dashv t_2$. Then $t_2\not\dashv t_1$.
\end{lemma}


%% \begin{remark}
%%   For simplfying the proofs we make the following assumption on a causal trace: for any transition $M\overset{f}{\remb} D\overset{g}{\lemb} N$, the functions $f$ and $g$ are the identity on
%% \end{remark}

\begin{lemma}
  \label{lemma:pos_infl}
  Let $\theta$ a causal trace and let $t_1:M_1\overset{m_1,p_1}{\Rightarrow}N_1$ and $t_2:M_2\overset{m_2,p_2}{\Rightarrow}N_2$ be two transitions in $\theta$. Then the following hold
  \begin{enumerate}
  \item $t_1 <_{\theta} t_2\implies$ there exists a unique cospan $s$ such that $p_1\xrightarrow{+}_s p_2$ and the causal pair of $t_1 <_{\theta} t_2$ is induced by $s$;
  \item $t_1\dashv_{\theta} t_2\implies$ there exists a unique cospan $s$ such that $p_1\xrightarrow{-}_s p_2$ and the inhibiting pair of $t_1\dashv_{\theta} t_2$ is induced by $s$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  \begin{enumerate}
  \item From~\autoref{def:causal_trace} $t_1 <_{\theta} t_2$ implies there exists two transitions $M\overset{m_1,p_1}{\Rightarrow} M_1$ and $M_1\overset{m_2,p_2}{\Rightarrow} M_2$ that are sequential dependent. For any such pair of transitions, using~\autoref{lem:completeness_causal_pair} there exists a causal pair induced by a cospan $s$, which in turns implies that $p_1\xrightarrow{+}_{s}p_2$.

  \item From~\autoref{def:causal_trace} $t_1 \dashv_{\theta} t_2$ implies there exists transitions $M\overset{m_1,p_1}{\Rightarrow} M_1$ inhibiting $M\overset{m_2,p_2}{\Rightarrow} M_2$. For any such pair of transitions, using~\autoref{lem:completeness_inhib_pair} there exists an inhibiting pair induced by a cospan $s$, which in turns implies that $p_1\xrightarrow{-}_s p_2$.
  \end{enumerate}
\end{proof}

\begin{lemma}
  \label{lem:constraint_mj}
  Let $\theta$ a causal trace and let $t_1:M_1\overset{m_1,p_1}{\Rightarrow}N_1$, $t_2:M_2\overset{m_2,p_2}{\Rightarrow}N_2$ and $t_3:M_3\overset{m_3,p_3}{\Rightarrow}N_3$ be three transitions in $\theta$. Let $p_i = L_i\remb K_i \lemb R_i$ be the three rules, for $i\in\{1,2,3\}$.
  \begin{enumerate}
  \item
    \label{lem:constraint_meet}
    If $t_1<_{\theta} t_3$ and $t_2<_{\theta} t_3$, then let $O_1$, $O_2$ be two graphs such that the causal pairs of $t_1<_{\theta} t_3$ and $t_2<_{\theta} t_3$ are induced by $O_1$ and $O_2$ respectively.
%$p_1\xrightarrow{+}_{O_1}p_3$ and $p_2\xrightarrow{+}_{O_2}p_3$.
Let $O_1\remb O\lemb O_2$ be the pullback of the span $O_1\lemb L_3 \remb O_2$. If $t_1\not\dashv t_2$ and $t_2\not\dashv t_1$ then there exists the morphisms $O\emb K_1$ and $O\emb K_2$ such that the diagram below commutes:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(O\)};
      \node (r3) at (0,1) {\(L_3\)};
      \node (o1) at (-1,0) {\(O_1\)};
      \node (o2) at (1,0) {\(O_2\)};
      \node (r1) at (-2,1) {\(R_1\)};
      \node (r2) at (2,1) {\(R_2\)};
      \node (k1) at (-3,0) {\(K_1\)};
      \node (k2) at (3,0) {\(K_2\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (o2);
      \draw [->] (o1) -- (r3);
      \draw [->] (o2) -- (r3);
      \draw [->] (o1) -- (r1);
      \draw [->] (o2) -- (r2);
      \draw [->] (k1) -- (r1);
      \draw [->] (k2) -- (r2);
      \draw [->] (o) to [bend left] (k1);
      \draw [->] (o) to [bend right] (k2);
    \end{tikzpicture}
    \]
    Moreover
    \begin{align*}
      t_1^{-1}\dashv t_2^{-1}\implies\text{ there exists the morphisms }O\emb K_1\text{ and }\\
      t_2^{-1}\dashv t_1^{-1}\implies\text{ there exists the morphisms }O\emb K_2.
    \end{align*}
  \item
    \label{lem:constraint_join}
    If $t_3 <_{\theta} t_1$ and $t_3<_{\theta} t_2$, then let $O_1$, $O_2$ be two graphs such that the causal pairs of $t_3 <_{\theta} t_1$ and $t_3<_{\theta} t_2$ are induced by $O_1$ and $O_2$ respectively.
Let $O_1\remb O\lemb O_2$ be the pullback of the span $O_1\lemb R_3 \remb O_2$. If $t_1\not\dashv t_2$ and $t_2\not\dashv t_1$
then there exists the morphisms $O\emb K_1$ and $O\emb K_2$ such that the diagram below commutes:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(O\)};
      \node (r3) at (0,1) {\(R_3\)};
      \node (o1) at (-1,0) {\(O_1\)};
      \node (o2) at (1,0) {\(O_2\)};
      \node (r1) at (-2,1) {\(L_1\)};
      \node (r2) at (2,1) {\(L_2\)};
      \node (k1) at (-3,0) {\(K_1\)};
      \node (k2) at (3,0) {\(K_2\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (o2);
      \draw [->] (o1) -- (r3);
      \draw [->] (o2) -- (r3);
      \draw [->] (o1) -- (r1);
      \draw [->] (o2) -- (r2);
      \draw [->] (k1) -- (r1);
      \draw [->] (k2) -- (r2);
      \draw [->] (o) to [bend left] (k1);
      \draw [->] (o) to [bend right] (k2);
    \end{tikzpicture}
    \]
    Moreover
    \begin{align*}
      t_1\dashv t_2\implies\text{ there exists the morphisms }O\emb K_1\text{ and }\\
      t_2\dashv t_1\implies\text{ there exists the morphisms }O\emb K_2.
    \end{align*}
  \end{enumerate}
\end{lemma}
\begin{proof}
  \begin{enumerate}
  \item
    %% If $\theta$ is a causal trace then we can show that there exists $t_1'$ and $t_2'$ such that $t_1\congr t_1'$, $t_2\congr t_2'$ and such that the transitions $t_1';t_2';t_3$ are composable and such that $t_1'\Diamond_{\text{seq}} t_2'$.
    %% %
    %% Let $\theta'$ be the smallest subtrace of $\theta$ that contains all three transitions $t_1$, $t_2$ and $t_3$. Suppose that $t_1$ occurs before $t_2$, that is $\theta':t_1;\cdots t_2\cdots t_3$.
    %% From $t_2<_{\theta} t_3$ we have that there exists $t_2'$ such that $t_2'< t_3$. It implies that there exists a trace $\theta_1\congr\theta'$ such that $t_2';t_3$ is at the end of $\theta'$.
    %% Using a similar argument as above, there exist $t_1'$ such that $t_1'<_{\theta} t_3$ and we can rewrite $\theta$ to $\theta_1$ ending in $t_1';t_2';t_3$ and with $t_1'\Diamond_{\text{seq}} t_2'$.
    %% %
    %% Consider now the trace $t_1';t_2';t_3$ with $t_2':M_2\remb D_2 \lemb M_3$. We can rewrite $t_1';t_2';t_3$ as $t_2'';t_1'';t_3$, with $t_1'\congr t_1''$ and $t_2'\congr t_2''$. Then we also have the trace $t_2';t_1''^{-1}$ with the two transition sequential independent. Therefore we have that there exists a morphism $R_1\emb D_2$ that makes the diagram commute.

    From $t_1<_{\theta} t_3$ we have that there exists $t_1'\simeq t_1$ such that $t_1';t_3$. Let us denote
$t_1':M_1\remb D_1 \lemb M_3$ the transition $t_1'$. Similarly, from $t_2<_{\theta} t_3$ there exists $t_2\simeq t_2$, $t_2';t_3$ and $t_2':M_2\remb D_2 \lemb M_3$.
    We can show that there exists a morphism $R_1\to D_2$ such that the diagram below commutes iff there is also a morphism $O\to K_2$ that commutes.
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(O\)};
      \node (r3) at (0,1) {\(L_3\)};
      \node (o1) at (-1,0) {\(O_1\)};
      \node (o2) at (1,0) {\(O_2\)};
      \node (r1) at (-2,1) {\(R_2\)};
      \node (r2) at (2,1) {\(R_1\)};
      \node (k1) at (-3,1) {\(K_2\)};
      \node (l1) at (-4,1) {\(L_2\)};
      \node (m3) at (0,2.5) {\(M_3\)};
      \node (d2) at (-2,2.5) {\(D_2\)};
      \node (m2) at (-3,2.5) {\(M_2\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (o2);
      \draw [->] (o1) -- (r3);
      \draw [->] (o2) -- (r3);
      \draw [->] (o1) -- (r1);
      \draw [->] (o2) -- (r2);
      \draw [->] (k1) -- (r1);
      \draw [->] (o) to [bend left] (k1);
      \draw [->] (k1) -- (l1);
      \draw [->] (d2) -- (m2);
      \draw [->] (d2) -- (m3);
      \draw [->] (k1) -- (d2);
      \draw [->] (l1) -- (m2);
      \draw [->] (r1) -- (m3);
      \draw [->] (r3) -- (m3);
      \draw [->] (r2) -- (m3);
      \draw [dotted,->] (r2) -- (d2);
    \end{tikzpicture}
    \]
    We have then that if $t_2\not\dashv t_1$ then the morphism $O\to K_2$ above exists and moreover if there is no morphism $O\to K_2$ that commutes then $t_2\dashv t_1$. We reason similarly for $t_1\dashv t_2$.

    From~\autoref{lem:inhibiting_pair}, if $t_2\dashv t_1$ then $t_1\not\dashv t_2$ and hence there exists $O\to K_1$ that commutes.
    \item The proof is similar to the one above.
  \end{enumerate}
\end{proof}

Inutuitively,~\autoref{lem:constraint_mj} says that if two events cannot \emph{produce} the same resource (\autoref{lem:constraint_meet}) and the same resource cannot be \emph{consumed} twice (\autoref{lem:constraint_join}). Let us give some examples.
\begin{example}
  For the following rules:
  \[
  r_1:\varepsilon \Rightarrow A,B \qquad r_2: \varepsilon \Rightarrow A,C \qquad r_3: A,B,C \Rightarrow D
  \]
  there is a trace where $t_1<t_3$ and $t_2<t_3$, however both cannot produce $A$:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(A\)};
      \node (r3) at (0,1) {\(A,B,C\)};
      \node (o1) at (-1,0) {\(A,B\)};
      \node (o2) at (1,0) {\(A,C\)};
      \node (r1) at (-2,1) {\(A,B\)};
      \node (r2) at (2,1) {\(A,C\)};
      \node (k1) at (-3,0) {\(\varepsilon\)};
      \node (k2) at (3,0) {\(\varepsilon\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (o2);
      \draw [->] (o1) -- (r3);
      \draw [->] (o2) -- (r3);
      \draw [->] (o1) -- (r1);
      \draw [->] (o2) -- (r2);
      \draw [->] (k1) -- (r1);
      \draw [->] (k2) -- (r2);
    \end{tikzpicture}
    \]
  %% \[
  %% t_1: A \Rightarrow A,B \qquad t_2: A \Rightarrow A,C \qquad t_3: A,B,C \Rightarrow D
  %% \]
  %% we can indeed have that both $t_1<t_3$ and $t_2<t_3$.
\end{example}
\begin{example}
  Consider the transitions
  \[
  t_3: \varepsilon \Rightarrow A\qquad t_1: A\Rightarrow \varepsilon \qquad t_2: A\Rightarrow \varepsilon
  \]
  for which there is no trace where both $t_3<t_1$ and $t_3<t_2$ hold. The resource $A$ produced by $t_1$ can only be consumed once.
  If, however, $t_1$ and $t_2$ do not consume $A$ but preserve it:
  \[
  t_3: \varepsilon \Rightarrow A\qquad t_1: A\Rightarrow A,B \qquad t_2: A\Rightarrow A,C
  \]
  then indeed both $t_1<t_3$ and $t_2<t_3$ hold.
\end{example}
  %% Note that though the following trace $\theta$, produced by transitions $t_3;t_1;t_2$, is valid
  %% \[
  %% \theta:\varepsilon \Rightarrow A \Rightarrow A, B\Rightarrow B\qquad t_3: \varepsilon \Rightarrow A\qquad t_1: A\Rightarrow A,B\qquad t_2: A\Rightarrow \varepsilon
  %% \]
  %% we cannot deduce $t_3<t_2'$, for $t_2'\congr t_2$, as in the trace $\theta$ above, transitions cannot commute.
\begin{example}
  For a trace $t_1;t_2;t_3$ with the transitions
  \[
  t_1: A \Rightarrow A,B\qquad t_2: A,B\Rightarrow B,C \qquad t_3: B,C\Rightarrow D
  \]
  one cannot deduce $t_1<t_3$, as transitions $t_1$ and $t_2$ do not commute.
\end{example}


%% \begin{remark}
%%   Sequential dependence (~\autoref{def:seq_dep}) is not transitive. Therefore when considering posets in~\autoref{def:poset}, we need to distinguish between the \emph{immediate} order relation (the cover relation in~\autoref{def:poset}) and its transitive closure. %We denote the first $\cover$ and the latter with $\tleq$.
%% \end{remark}

\begin{lemma}
  \label{lem:constraint_inhibit}
  Let $\theta$ a causal trace and let $t_1:M_1\overset{m_1,p_1}{\Rightarrow}N_1$ and $t_2:M_2\overset{m_2,p_2}{\Rightarrow}N_2$ be two transitions in $\theta$.
  If $t_1 \leq t_2$ then $t_2\not\dashv t_1$.
\end{lemma}
\begin{proof}[Proof sketch]
  One cannot commute $t_1$ and $t_2$ such that $t_1':M\overset{m_1,p_1}{\Rightarrow}N_1$ and $t_2':M\overset{m_2,p_2}{\Rightarrow}N_2$, for some $t_1'\simeq t_1$, $t_2'\simeq t_2$. Therefore one cannot deduce that the pair are not parallel independent.
\end{proof}

\begin{definition}[Augmented poset]
  Let $s=(E,\cover,\dashv,\labl)$ be a set of events equipped with two binary relations on events $\cover$ and $\dashv$ and a labelling function $\labl:E\to R$. We can retrive a poset from $s$, denoted $(E,\leq)$, where $\leq$ is the transitive and reflexive closure of $\cover$.
  %Let $s=(E, \leq,\dashv,\labl)$ be a set of events equipped with a partial order $\leq$, a binary relation on events $\dashv$ and a labelling function $\labl:E\to R$.
  We call $s$ an \emph{augmented poset}.
\end{definition}

\begin{definition}[Decorated poset]
  \begin{enumerate}
  \item[] $~$
  \item Given a set of events $E$ and a labeling function $\labl$ on events, define a function $\decor:E\times E \to E\times E\times G$ that associates to a pair of events $(e,e')$ the following set
    \begin{align*}
      \decor_{+}(e,e') = \{(e,e',O) : O\text{ is a graph such that }\labl(e)\redl{+}_O \labl(e')\}\\
       \decor_{-}(e,e') = \{(e,e',O) : O\text{ is a graph such that }\labl(e)\redl{-}_O \labl(e')\}
    \end{align*}

  \item Let $s = (E,\cover,\dashv,\labl)$ be an augmented poset. A \emph{decorated} poset of $s$, denoted $s^{\star}$, is defined as follows
    \begin{align*}
      s^{\star} = (E,\redl{+},\redl{-},\labl), \text{ where }
      &e\redl{+}_O e' \iff (e,e',O)\in\decor_+(e,e')\text{ and }e\cover e'\\
      &e\redl{-}_O e' \iff (e,e',O)\in\decor_-(e,e')\text{ and }e\dashv e'\\
    \end{align*}
    We denote $\decor(s)$ the set of all decorated posets of $s$.
  \end{enumerate}
\end{definition}

Note that the notation $e\redl{+}_O e'$ is an overload of the notation $\labl(e)\redl{+}_O \labl(e')$. The first is defined on events using the abstraction function. The second, defined on rules, can be inferred from the rules itself.

\begin{definition}[The abstraction on a trace]
  \label{def:abstraction}
  Let us denote with $\Theta$ the set of causal traces.
  Define $\alpha:\Theta\to\mathcal{S}$ an \emph{abstraction} function that maps a trace into a poset as follows:
    \begin{itemize}
    \item given a transition $t:M\overset{m,p}{\Rightarrow} M'$ define the \emph{abstract event} $e$ associated to it
      $\alpha(t) = e_t$ such that $\labl(e) = p$.
    %% \item define an augmented poset from a trace $\alpha(\theta) = (E,\cover,\dashv,\labl)$ such that $\alpha$ is a bijection between transitions and abstract events and such that the sequential dependence and inhibition relations between transitions is preserved:
    %%   \begin{align*}
    %%     %\alpha(t_i:M_{i-1}\overset{m_{i},p_{i}}{\Rightarrow}M_i) = e_i \\
    %%     e_i \cover e_j \iff t_i <_{\theta} t_j \text{ and } \alpha(t_i)=e_i, \alpha(t_j)=e_j\\
    %%     e_i \dashv e_j \iff t_i \dashv_{\theta} t_j \text{ and } \alpha(t_i)=e_i, \alpha(t_j)=e_j.
    %%   \end{align*}
    \item define a decorated poset from a trace $\alpha(\theta) = (E,\redl{+},\redl{-},\labl)$ such that $\alpha$ is a bijection between transitions and abstract events and such that the sequential dependence and inhibition relations between transitions is preserved:
      \begin{align*}
        %\alpha(t_i:M_{i-1}\overset{m_{i},p_{i}}{\Rightarrow}M_i) = e_i \\
        e_i \redl{+}_O e_j \iff t_i <_{\theta} t_j, \labl(t_i) \redl{+}_O \labl(t_j)
        \text{ and } \alpha(t_i)=e_i, \alpha(t_j)=e_j\\
        e_i \redl{-}_O e_j \iff t_i \dashv_{\theta} t_j, \labl(t_i) \redl{-}_O \labl(t_j)
        \text{ and } \alpha(t_i)=e_i, \alpha(t_j)=e_j.
      \end{align*}
    \end{itemize}
  %\item
    Let $\Theta = \{\theta_1,\cdots,\theta_n\}$ be a set of causal traces.
    Define the set of decorated posets $\mathcal{S}$ obtained by abstraction on $\Theta$ as follows
    \[
    \alpha(\{\theta_1,\cdots,\theta_n\}) = (s_1,\cdots, s_k)\text{ with }k\leq n
    \]
    where for each decorated poset $s$ there exists at least one trace $\theta\in\Theta$ such that $\alpha(\theta) = s$.
  %\end{itemize}
\end{definition}

\begin{definition}[Valid decorated poset]
  \label{def:constraints_poset}
  A decorated poset $s = (E,\redl{+},\redl{-},\labl)$ is \emph{valid} if the following hold:
  \begin{description}
  \item[directed]
    $s$ is directed w.r.t. the transitive and reflexive closure of $\redl{+}$;
  \item[events are not pairwise inhibiting]
    $\forall e_1,e_2\in s$, $e_1\redl{-}_s e_2\implies \neg(e_2 \redl{-}_{s'} e_1)$, for some $s$, $s'$;
  \item[events cannot inhibit their causes]
    $\forall e_1,e_2\in s$, $e_1\leq e_2\implies \neg(e_2 \redl{-}_{s} e_1)$, for some $s$;
  \item[constraints on decorating meets]
    $\forall e_1,e_2,e_3\in s$ such that $e_1\redl{+}_{s_1} e_3$ and $e_2\redl{+}_{O_2} e_3$, let $O_1\remb O\lemb O_2$ be the pullback of the span $O_1\lemb L_3 \remb O_2$.
If there is no $s$, $s'$ such that $e_1\redl{-}_s e_2$ and $e_2\redl{-}_{s'} e_1$ then there exists the morphisms $O\emb K_1$ and $O\emb K_2$ such that the diagram below commutes:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(O\)};
      \node (r3) at (0,1) {\(L_3\)};
      \node (o1) at (-1,0) {\(O_1\)};
      \node (o2) at (1,0) {\(O_2\)};
      \node (r1) at (-2,1) {\(R_1\)};
      \node (r2) at (2,1) {\(R_2\)};
      \node (k1) at (-3,0) {\(K_1\)};
      \node (k2) at (3,0) {\(K_2\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (o2);
      \draw [->] (o1) -- (r3);
      \draw [->] (o2) -- (r3);
      \draw [->] (o1) -- (r1);
      \draw [->] (o2) -- (r2);
      \draw [->] (k1) -- (r1);
      \draw [->] (k2) -- (r2);
      \draw [->] (o) to [bend left] (k1);
      \draw [->] (o) to [bend right] (k2);
    \end{tikzpicture}
    \]
  \item[constraints on decorating joins]
    $\forall e_1,e_2,e_3\in s$ such that $e_3\redl{+}_{s_1} e_1$ and $e_3\redl{+}_{O_2} e_2$, let $O_1\remb O\lemb O_2$ be the pullback of the span $O_1\lemb L_3 \remb O_2$.
    If there is no $s$, $s'$ such that $e_1\redl{-}_s e_2$ and $e_2\redl{-}_{s'} e_1$ then there exists the morphisms $O\emb K_1$ and $O\emb K_2$ such that the diagram below commutes:
       \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(O\)};
      \node (r3) at (0,1) {\(R_3\)};
      \node (o1) at (-1,0) {\(O_1\)};
      \node (o2) at (1,0) {\(O_2\)};
      \node (r1) at (-2,1) {\(L_1\)};
      \node (r2) at (2,1) {\(L_2\)};
      \node (k1) at (-3,0) {\(K_1\)};
      \node (k2) at (3,0) {\(K_2\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (o2);
      \draw [->] (o1) -- (r3);
      \draw [->] (o2) -- (r3);
      \draw [->] (o1) -- (r1);
      \draw [->] (o2) -- (r2);
      \draw [->] (k1) -- (r1);
      \draw [->] (k2) -- (r2);
      \draw [->] (o) to [bend left] (k1);
      \draw [->] (o) to [bend right] (k2);
    \end{tikzpicture}
    \]
  \end{description}
  where $\labl(e_i)=r_i:L_i\remb K_i\lemb R_i$.
\end{definition}

\begin{lemma}
  \label{prop:constraints_poset}
  For any causal trace $\theta$, $\alpha(\theta)$ is a valid decorated poset.
\end{lemma}
\begin{proof}
  It is straigthforward from~\autoref{def:causal_trace},~\autoref{lem:inhibiting_pair},~\autoref{lem:constraint_inhibit} and \autoref{lem:constraint_mj}.
\end{proof}

If we work only on augmented posets, the abstraction is "too forgetful".
The following examples give an intuition of why the abstraction function has to preserve the inhibition relation and the decorations on causality and inhibition.
We make this intuition formal in~\autoref{th:correction}.

\begin{example}
  Let us consider the following rules and trace:
  \begin{align*}
    r_1:A \Rightarrow A, B\qquad r_2:A \Rightarrow C \qquad r_3: B,C \Rightarrow C\qquad
    A \overset{\id_A,r_1}{\Rightarrow} A, B \overset{\id_A,r_2}{\Rightarrow} B,C \overset{id_{B,C},r_3}{\Rightarrow}C.
  \end{align*}
  Let us denote $t_1$, $t_2$ and $t_3$ the three transitions. We have that $t_1<t_3$, $t_2<t_3$ and $t_2\dashv t_1$. If we "forget" that $t_2\dashv t_1$ we retrieve a trace where $t_1$ and $t_2$ are sequential independent:
  \begin{align*}
    A_1,A_2 \overset{\id_{A_1},r_1}{\Rightarrow} A_1,A_2,B \overset{\id_{A_2},r_2}{\Rightarrow} A_1,B,C \overset{id_{B,C},r_3}{\Rightarrow} A_1,C.
  \end{align*}
  From such an abstraction it is not possible to recover the original trace.
\end{example}

%% \begin{example} - for the cover relation
%%   Let us consider the following rules:
%%   \begin{align*}
%%     r_1:\varepsilon \Rightarrow A, B\qquad r_2:A \Rightarrow C \qquad r_3: B,C \Rightarrow C
%%   \end{align*}
%%   and the trace
%%   \begin{align*}
%%     \varepsilon \overset{\emptyset,r_1}{\Rightarrow} A, B \overset{\id_A,r_2}{\Rightarrow} B,C \overset{id_{B,C},r_3}{\Rightarrow}C.
%%   \end{align*}
%%   Let us denote $t_1$, $t_2$ and $t_3$ the three transitions. We have that $t_1<t_3$, $t_2<t_3$ and $t_1< t_2$. If we "forget" that $t_1< t_3$ (as both $t_1<t_2$ and $t_2<t_3$ hold), we retrieve the following trace:
%%   \begin{align*}
%%     B_1 \overset{\emptyset,r_1}{\Rightarrow} B_1,A,B_2 \overset{\id_{A},r_2}{\Rightarrow} B_1,A,B_2,C \overset{id_{B_1,C},r_3}{\Rightarrow} B_2,A_1,C.
%%   \end{align*}
%% \end{example}

\begin{example}
  If, in the following trace $\theta$, produced by the transitions $t_1;t_2;t_3$, we forget the decoration we obtain a poset with three events $e_1,e_2,e_3$ such that $e_1<e_3$ and $e_2<e_3$.
  \[
  \theta:\varepsilon \Rightarrow A \Rightarrow A,B\Rightarrow A,B,C\qquad t_1: \varepsilon \Rightarrow A\qquad t_2: \varepsilon\Rightarrow A,B\qquad t_2: A,B\Rightarrow A,B,C
  \]
  But we can come up with two decorations for such poset, where one of them leads to a invalid decorated poset:
  \begin{align*}
  \text{good decoration: }&e_1\redl{+}_A e_3\qquad e_2\redl{+}_B e_3\\
  \text{bad decoration: }&e_1\redl{+}_A e_3\qquad e_2\redl{+}_A e_3
  \end{align*}
\end{example}

\subsection{Refinement of decorated posets}

\begin{lemma}[Update of a decoration after a refinement]
  \label{lem:update_dec}
  Let $(E,\redl{+},\redl{-},\labl)$ be a valid decorated poset and let $e_1$ and $e_2$ be two events such that $e_1\redl{+}_{s_1} e_2$ and $e_2\redl{-}_{s_2} e_1$, for two cospans $s_1$ and $s_2$ possibly empty.
  \begin{enumerate}
  \item If there exists $e_3$ and $s:R_i\remb O \lemb L_3$ such that $e_i\redl{+}_s e_3$ with $i\in\{1,2\}$ then there exists $s':M_2\lemb O'\remb L_3$ such that $\big( M_1\remb K\lemb M_2\big)\redl{+}_{s'} r_3$ and such that the diagram commutes:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (ri) at (-1,1) {\(R_i\)};
      \node (m2) at (3,1) {\(M_2\)};
      \node (l3) at (2,1) {\(L_3\)};
      \node (o) at (0,0) {\(O\)};
      \node (o1) at (2,0) {\(O'\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (l3);
      \draw [->] (o1) -- (l3);
      \draw [->] (o) -- (ri);
      \draw [->] (o1) -- (m2);
    \end{tikzpicture}
    \]
    where $\big(\labl(e_1)\otimes_{(s_1\times s_2)} \labl(e_2)\big) = M_1\remb K\lemb M_2$.
  %% \item If there exists $e_3$ and $s:L_i\remb O \lemb L_3$ such that $e_i\redl{-}_s e_3$ with $i\in\{1,2\}$ then there exists $s':M_1\lemb O'\remb L_3$ such that $\big( M_1\remb K\lemb M_2\big)\redl{-}_{s'} r_3$ and such that the diagram commutes:
  %%   \[
  %%   \begin{tikzpicture} %[scale=0.8]
  %%     \node (ri) at (-1,1) {\(L_i\)};
  %%     \node (m2) at (3,1) {\(M_1\)};
  %%     \node (l3) at (2,1) {\(L_3\)};
  %%     \node (o) at (0,0) {\(O\)};
  %%     \node (o1) at (2,0) {\(O'\)};
  %%     \draw [->] (o) -- (o1);
  %%     \draw [->] (o) -- (l3);
  %%     \draw [->] (o1) -- (l3);
  %%     \draw [->] (o) -- (ri);
  %%     \draw [->] (o1) -- (m2);
  %%   \end{tikzpicture}
  %%   \]
  %%   where $\big(\labl(e_1)\otimes_{(s_1\times s_2)} \labl(e_2)\big) = M_1\remb K\lemb M_2$.
  \item If there exists $e_3$ and $s:R_i\remb O \lemb L_3$ such that $e_3\redl{+}_s e_i$ with $i\in\{1,2\}$ then there exists $s':M_2\lemb O'\remb L_3$ such that $r_3\redl{+}_{s'}\big( M_1\remb K\lemb M_2\big)$ and such that the diagram commutes:
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (ri) at (-1,1) {\(R_3\)};
      \node (m2) at (3,1) {\(M_1\)};
      \node (l3) at (2,1) {\(L_i\)};
      \node (o) at (0,0) {\(O\)};
      \node (o1) at (2,0) {\(O'\)};
      \draw [->] (o) -- (o1);
      \draw [->] (o) -- (l3);
      \draw [->] (o1) -- (l3);
      \draw [->] (o) -- (ri);
      \draw [->] (o1) -- (m2);
    \end{tikzpicture}
    \]
    where $\big(\labl(e_1)\otimes_{(s_1\times s_2)} \labl(e_2)\big) = M_1\remb K\lemb M_2$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  \begin{enumerate}
  \item Let us first show the property above for $r_1$.
    We have the following diagram from~\autoref{def:ref_pos_neg_infl}, where $O_3$ is a graph such that $O_1\emb O_3$ and $O_2\emb O_3$.
    \[
    \begin{tikzpicture} %[scale=0.8]
      \node (o) at (0,-1) {\(O_3\)};
      \node (m) at (0,1) {\(M\)};
      \node (d2) at (1,1) {\(\circ\)};
      \node (m2) at (3,1) {\(M_2\)};
      \node (d1) at (-1,1) {\(D_1\)};
      \node (m1) at (-3,1) {\(\circ\)};
      \node (r1) at (-1,0) {\(R_1\)};
      \node (k1) at (-2,0) {\(K_1\)};
      \node (l1) at (-3,0) {\(\circ\)};
      \node (l2) at (1,0) {\(L_2\)};
      \node (k2) at (2,0) {\(\circ\)};
      \node (r2) at (3,0) {\(\circ\)};
      \node (k) at (0,2) {\(K\)};
      \node (l3) at (4,0.5) {\(L_3\)};
      \node (o2) at (2,-1) {\(O\)};
      \node (o1) at (4,-1) {\(O'\)};
      \draw [->] (o) -- (r1);
      \draw [->] (o) -- (l2);
      \draw [->] (r1) -- (m);
      \draw [->] (k1) -- (r1);
      \draw [->] (k1) -- (l1);
      \draw [->] (k1) -- (d1);
      \draw [->] (l1) -- (m1);
      \draw [->] (l2) -- (m);
      \draw [->] (k2) -- (r2);
      \draw [->] (k2) -- (l2);
      \draw [->] (k2) -- (d2);
      \draw [->] (r2) -- (m2);
      \draw [->] (d1) -- (m);
      \draw [->] (d1) -- (m1);
      \draw [->] (d2) -- (m);
      \draw [->] (d2) -- (m2);
      \draw [->] (k) -- (d1);
      \draw [->] (k) -- (d2);
      \draw [->] (o2) -- (o1);
      \draw [->] (o2) -- (l3);
      \draw [->] (o1) -- (l3);
      \draw [->] (o2) -- (r1);
      \draw [->] (o1) -- (m2);
    \end{tikzpicture}
    \]
    We have that $n_1(o(O))\subseteq M$. We distinguish two cases:
    \begin{itemize}
    \item if $n_1(o(O)) \cap m_2(L_2)=\emptyset$ then $f_2^{-1}$ is defined on $n_1(o(O))$. Hence there exists a morphism $o_2:O\emb M_2$ such that $o_2 = g_2 \circ (f_2^{-1}) \circ n_1 \circ o$. Moreover, as $O$ does not embed into $K_1$ (from $e_1\redl{+}_O e_3$), then we can show by contradiction that there is no morphism $O\emb D_1$ nor $O\emb K$ such that the diagram commutes. Therefore we have that there exists $O'$ such that $\labl(e_1)\otimes_{O_1,O_2} \labl(e_2)\redl{+}_{O'} e_3$ and $O\subseteq O'$.
    \item if $n_1(o(O)) \cap m_2(L_2)\neq\emptyset$, then again we distinguish two subcases. A first one is that $f_2^{-1}$ is defined on $n_1(o(O)) \cap m_2(L_2)$, in which case the proof follows as above. Otherwise, we have that there exists $O''\subseteq O$ such that $e_1\redl{+}_{O''} e_2$ and $e_1\redl{+}_{O''} e_3$ which contradicts the contraints on decoration of meets from~\autoref{prop:constraints_poset}.
    \end{itemize}

    The property holds for $r_2$ in a similar manner, except that we use the contraints on decoration of joins from~\autoref{prop:constraints_poset} for the last case.

  \item
    \begin{mdframed}[backgroundcolor=blue!20]
      to do
    \end{mdframed}
  \end{enumerate}
\end{proof}

  Let $e_1$ and $e_2$ be two events of a decorated poset and $s_1,s_2$ be two cospans such that $(\labl(e_1)\otimes_{s_1\otimes s_2} \labl(e_2)) = r_{12}$ is well defined. Moreover, let $e_3$ be an event and $s$ a cospan such that $e_1\redl{+}_s e_3$. We use the notation $\big(e_1\redl{+}_O e_3\big)_{e_1\otimes e_2}$ denotes the set of all decorations $r_{12}\redl{+}_{s'} \labl(e_3)$, where $s'$ is obtained as in~\autoref{lem:update_dec}. We use similar notations for the negative influence and the influences of $e_2$ on $e_3$.

\begin{lemma}[The update is associative]
  \label{lem:assoc}
   Let $e_1,e_2,e_3$ be three events in a decorated poset and $s_1,s_2$ be two cospans such that $e_1\redl{+}_{s_1} e_2\redl{+}_{s_2} e_3$.
   Moreover, let $e_1\oplus_{s_1} e_2 = r_{12}$ and $e_2\oplus_{s_2} e_3 = r_{23}$ be the two refinements.
   Then, for any cospan $s$ such that
   $r_{12}\redl{+}_{s} \labl(e_3)\in\big(e_2\redl{+}_{s_2} e_3\big)_{e_1\otimes e_2}$ there exists a graph $s'$ such that
   $\labl(e_{1})\redl{+}_{s'} r_{23}\in\big(e_1\redl{+}_{s_1} e_2\big)_{e_2\otimes e_3}$ and such that
   \begin{align*}
     (r_1\oplus_{s_1} r_2)\oplus_{s} r_3 \iso r_1\oplus_{s'} (r_2\oplus_{s_3} r_3).
   \end{align*}
\end{lemma}
\begin{mdframed}[backgroundcolor=blue!20]
  \begin{proof}
    to do
  \end{proof}
\end{mdframed}

\begin{mdframed}[backgroundcolor=blue!20]
Adapt \autoref{lem:update_dec} and \autoref{lem:assoc} to inhibition.
\end{mdframed}

\begin{definition}
  Let $e_1,e_2\in E$ be two events of a decorate poset $s$ such that $e_1\redl{+}_{s_1}e_2$, $e_2\redl{-}_{s_2}e_2$ for some $s_1$, $s_2$ possibly empty. Then $\labl(e_1)\otimes_{(s_1\otimes s_2)} r_2=r_{12}$ is well defined.

  Define $s_{(e_1\otimes e_2)} = (E\setminus\{e_1,e_2\}\uplus\{e_{12}\},\overset{+}{\leadsto},\overset{-}{\leadsto},\labl')$ such that
    \begin{align*}
    &\labl'(e)=\labl(e), \forall e,e'\in E\setminus\{e_1,e_2\}\\
    &e\overset{+}{\leadsto}_s e' \iff e\redl{+}_s e', \forall e,e'\in E\setminus\{e_1,e_2\}\\
    &e\overset{-}{\leadsto}_s e' \iff e\redl{-}_s e', \forall e,e'\in E\setminus\{e_1,e_2\}\\
    &\labl'(e_{12}) = r_{12}\\
    &e_{12}\overset{+}{\leadsto}_s e \iff r_{12}\redl{+}_s \labl(e)\in \big(e_i \redl{+}_{s'} e\big)_{e_1\otimes e_2}\\
   % \text{ and }e_i\redl{+}_{O'} e\\
    &e_{12}\overset{-}{\leadsto}_s e \iff r_{12}\redl{-}_s \labl(e)\in \big(e_i \redl{-}_{s'} e\big)_{e_1\otimes e_2}\\
    %\text{ and }e_i\redl{-}_{O'} e\\
  \end{align*}
\end{definition}
%% \begin{lemma}
%%   Let $\underline s = (E,\seq,\redl{+},\redl{-},\labl)$ be a linear extension of a decorated poset $s$. For any two events $e_1,e_2$ such that $\big(s \big)_{e_1\otimes e_2}$ is well defined, $\big(\underline s \big)_{e_1\otimes e_2}$ is a linear extension of $\big(s \big)_{e_1\otimes e_2}$.
%% \end{lemma}

\begin{lemma}
  If $s$ is a valid decorated poset then for any two events $e_1,e_2$ in $s$, $s_{(e_1\otimes e_2)}$ is also a valid decorate poset.
\end{lemma}

\begin{definition}[Linear extensions of posets]
  A linear extension, denoted $\underline{s}$, of a poset $s=(E,\tleq)$ is any total order that extends the partial order $\tleq$. We denote $\linear(s)$ the set of all possible linear extensions of $s$.
  %% \[
  %% (E,\seq)\in\linear(s) \iff \forall e_1,e_2\in E, e_1\leq e_2\implies e_1\seq e_2.
  %% \]
  A linear extension of a augmented poset $s=(E,\cover,\dashv)$ is any total order such that
  \begin{align*}
    (E,\seq)\in\linear(s) \iff \forall e_1,e_2\in E, &e_1\leq e_2\implies e_1\seq e_2\\
    & e_1\dashv e_2\implies e_2\seq e_1.
  \end{align*}
\end{definition}

\begin{definition}[Refinement of a poset]
  \label{def:ref_poset}
  Let $\underline s=(E,\seq\redl{+},\redl{-},\labl)$ be a linear extension of a decorated poset $s$.
  Define $\mathtt{Ref}(\underline s)$ as follows
  \begin{align*}
    \mathtt{Ref}(\underline s) =&
    \mathtt{Ref}(\underline s')\text{ if }\exists e_1,e_2\in E, e_1\neq e_2, e_1\prec e_2, e_1\redl{+}e_2
    \text{ and }\underline s'=\big(\underline s\big)_{e_1\otimes e_2}
    \\
    &\underline s\text{ otherwise.}\\
  \end{align*}
\end{definition}


\subsection{From posets to traces}
%\input{old_concret}

\begin{definition}
  Let $\underline s=(E,\seq\redl{+},\redl{-},\labl)$ be a linear extension of a decorated poset $s$. A \emph{concretisation} function  $\mathtt{Concret}:E\leftrightarrow \{t_1,\cdots t_n\}$ is a bijection between events in $E$ and a set of transitions such that
  \begin{align*}
    e_1\redl{+}_s e_2 \iff& \mathtt{Concret}(e_1) = t_1, \mathtt{Concret}(e_1) = t_2, \text{ such that }t_1<_{t_1;t_2}t_2\\
    &\text{ and the causal pair of }t_1<_{t_1;t_2}t_2\text{ is induced by }s.
  \end{align*}
\end{definition}
%\input{old_ref}

\subsection{Interpreting inhibition on posets}

In interpreting our logic, we work with a set of posets in $\mathcal{S}$ and a set of events $\cup_{s\in\mathcal{S}} E_s$.

\begin{definition}[Refinement of an event in a poset]
  Let $e$ be an event in a decorated poset $s=(E,\redl{+},\redl{-},\labl)$.
  Define $\mathtt{Concret}(e\in s) = \mathtt{Concret}(e)$ for $\mathtt{Concret}:\underline{s}\to\{t_1,\cdots t_n\}$ a concretisation function.
  %We call such a graph $M$ a \emph{context of application} of $e$ in $s$.
\end{definition}

\begin{definition}[Refinement based on negative influence]
\label{def:ref_neg_infl}
  For two posets $s_1,s_2$ and two events $e_1\in s_1$ and $e_2\in s_2$ such that  $\mathtt{Concret}(e_1\in s_1) = M_1\Rightarrow N_1$ and $\mathtt{Concret}(e_2\in s_2) = M_2\Rightarrow N_2$, define $\mathtt{Concret}(e_1\in s_1\redl{-} e_2\in s_2) = M$ for which the diagram below commutes:
  \[
  \begin{tikzpicture} %[scale=0.8]
    \node (o) at (0,-0.5) {\(O\)};
    \node (n) at (0,2) {\(M\)};
    \node (l1) at (-1,0) {\(L_1\)};
    \node (l2) at (1,0) {\(L_2\)};
    \node (n1) at (-1,1) {\(M_1\)};
    \node (n2) at (1,1) {\(M_2\)};
    \draw [->] (l1) -- (n1);
    \draw [->] (l2) -- (n2);
    \draw [->] (o) -- (l1);
    \draw [->] (o) -- (l2);
    \draw [->] (n1) -- (n);
    \draw [->] (n2) -- (n);
  \end{tikzpicture}
  \]
  where $\labl(e_1)\redl{-}_s\labl(e_2)$, for some cospan $s:L_1\remb O\lemb L_2$.
\end{definition}
